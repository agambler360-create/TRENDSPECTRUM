<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Crypto Signals - Full Binance Spot Market</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a2e);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn.start { background: linear-gradient(45deg, #00b09b, #96c93d); }
        .btn.stop { background: linear-gradient(45deg, #ff416c, #ff4b2b); }
        .btn.test { background: linear-gradient(45deg, #667eea, #764ba2); }

        .filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: #00ff88;
        }

        .filter-btn.buy { border-color: #00ff88; color: #00ff88; }
        .filter-btn.sell { border-color: #ff416c; color: #ff416c; }
        .filter-btn.strong-buy { border-color: #00b09b; color: #00b09b; }
        .filter-btn.strong-sell { border-color: #ff4b2b; color: #ff4b2b; }
        .filter-btn.urgent-sell { border-color: #ff0000; color: #ff0000; }

        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff88;
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .signal-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .signal-card.strong-buy { border-left: 4px solid #00ff88; }
        .signal-card.buy { border-left: 4px solid #00ccff; }
        .signal-card.strong-sell { border-left: 4px solid #ff416c; }
        .signal-card.sell { border-left: 4px solid #ff4b2b; }
        .signal-card.urgent-sell { border-left: 4px solid #ff0000; }
        .signal-card.hold { border-left: 4px solid #ffd700; }

        .coin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .coin-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .signal-type {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .signal-strong-buy { background: #00ff88; color: #000; }
        .signal-buy { background: #00ccff; color: #000; }
        .signal-strong-sell { background: #ff416c; color: #fff; }
        .signal-sell { background: #ff4b2b; color: #fff; }
        .signal-urgent-sell { background: #ff0000; color: #fff; }
        .signal-hold { background: #ffd700; color: #000; }

        .price-info {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .price-change {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .indicator {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }

        .indicator-value {
            font-weight: bold;
        }

        .signals-list {
            margin-top: 10px;
        }

        .signal-item {
            padding: 4px 0;
            font-size: 0.85em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .confidence {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .high-confidence { background: rgba(0, 255, 136, 0.2); }
        .medium-confidence { background: rgba(255, 215, 0, 0.2); }
        .low-confidence { background: rgba(255, 65, 108, 0.2); }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #00ff88;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            transition: width 0.3s ease;
        }

        .indicator-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            margin-left: 5px;
            font-weight: bold;
        }

        .bullish { background: rgba(0, 255, 136, 0.3); color: #00ff88; }
        .bearish { background: rgba(255, 65, 108, 0.3); color: #ff416c; }
        .neutral { background: rgba(255, 215, 0, 0.3); color: #ffd700; }

        .analysis-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.8em;
            text-align: center;
        }

        .market-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .market-stat {
            text-align: center;
        }

        .market-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .signals-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .signals-grid {
                grid-template-columns: 1fr;
            }
            
            .controls, .filters {
                flex-direction: column;
            }
            
            .btn, .filter-btn {
                width: 100%;
            }
            
            .market-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Crypto Signals - Full Binance Spot Market</h1>
            <p>Real-time analysis of ALL Binance spot trading pairs with advanced technical indicators</p>
        </div>

        <div class="market-info">
            <div class="market-stat">
                <div>Total Pairs</div>
                <div class="market-value" id="totalPairs">0</div>
            </div>
            <div class="market-stat">
                <div>Strong Buy</div>
                <div class="market-value" id="marketStrongBuy">0</div>
            </div>
            <div class="market-stat">
                <div>Urgent Sell</div>
                <div class="market-value" id="marketUrgentSell">0</div>
            </div>
            <div class="market-stat">
                <div>Market Trend</div>
                <div class="market-value" id="marketTrend">-</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn start" onclick="startMonitoring()">🚀 Start Live Monitoring</button>
            <button class="btn stop" onclick="stopMonitoring()">🛑 Stop Monitoring</button>
            <button class="btn test" onclick="runSingleAnalysis()">🔍 Full Market Analysis</button>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="filterSignals('all')">All Signals</button>
            <button class="filter-btn strong-buy" onclick="filterSignals('strong-buy')">STRONG BUY</button>
            <button class="filter-btn urgent-sell" onclick="filterSignals('urgent-sell')">URGENT SELL</button>
            <button class="filter-btn buy" onclick="filterSignals('buy')">BUY Signals</button>
            <button class="filter-btn sell" onclick="filterSignals('sell')">SELL Signals</button>
            <button class="filter-btn strong-sell" onclick="filterSignals('strong-sell')">STRONG SELL</button>
        </div>

        <div class="status" id="status">
            🔄 Ready to analyze full Binance spot market...
        </div>

        <div class="dashboard">
            <div class="stats-panel">
                <h3>📊 Market Overview</h3>
                <div class="stat-item">
                    <div>Total Symbols</div>
                    <div class="stat-value" id="totalSymbols">0</div>
                </div>
                <div class="stat-item">
                    <div>Strong Buy</div>
                    <div class="stat-value" id="strongBuyCount">0</div>
                </div>
                <div class="stat-item">
                    <div>Buy Signals</div>
                    <div class="stat-value" id="buyCount">0</div>
                </div>
                <div class="stat-item">
                    <div>Urgent Sell</div>
                    <div class="stat-value" id="urgentSellCount">0</div>
                </div>
                <div class="stat-item">
                    <div>Strong Sell</div>
                    <div class="stat-value" id="strongSellCount">0</div>
                </div>
                <div class="stat-item">
                    <div>Sell Signals</div>
                    <div class="stat-value" id="sellCount">0</div>
                </div>
                <div class="stat-item">
                    <div>Last Update</div>
                    <div id="lastUpdate">-</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div id="progressText">0%</div>
                <div class="analysis-info" id="analysisInfo">
                    Analyzing: 0/0 coins
                </div>
            </div>

            <div class="signals-grid" id="signalsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Click "Full Market Analysis" to start scanning all spot pairs...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdvancedBinanceSignalsBot {
            constructor() {
                this.allSymbols = [];
                this.isMonitoring = false;
                this.historicalData = new Map();
                this.analysisResults = [];
                this.updateInterval = null;
                this.currentFilter = 'all';
                this.analysisSpeed = 100; // ms между запросами
                this.maxSymbols = 200; // Максимальное количество пар для анализа
            }

            async fetchAllSymbols() {
                try {
                    const url = 'https://api.binance.com/api/v3/exchangeInfo';
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Binance API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Фильтруем только спотовые пары с USDT
                    const spotSymbols = data.symbols
                        .filter(symbol => 
                            symbol.status === 'TRADING' && 
                            symbol.quoteAsset === 'USDT' &&
                            !symbol.symbol.includes('UP') &&
                            !symbol.symbol.includes('DOWN') &&
                            !symbol.symbol.includes('BULL') &&
                            !symbol.symbol.includes('BEAR')
                        )
                        .map(symbol => symbol.symbol);
                    
                    // Ограничиваем количество для производительности
                    this.allSymbols = spotSymbols.slice(0, this.maxSymbols);
                    document.getElementById('totalPairs').textContent = this.allSymbols.length;
                    return this.allSymbols;
                    
                } catch (error) {
                    console.error('Error fetching symbols:', error);
                    // Возвращаем дефолтный список в случае ошибки
                    return this.getDefaultSymbols();
                }
            }

            getDefaultSymbols() {
                // Основные популярные пары как запасной вариант
                const defaultSymbols = [
                    'BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'XRPUSDT',
                    'ADAUSDT', 'AVAXUSDT', 'DOTUSDT', 'LINKUSDT', 'MATICUSDT',
                    'DOGEUSDT', 'LTCUSDT', 'ATOMUSDT', 'ETCUSDT', 'XLMUSDT',
                    'ALGOUSDT', 'FILUSDT', 'EOSUSDT', 'XTZUSDT', 'SANDUSDT',
                    'MANAUSDT', 'GALAUSDT', 'ENJUSDT', 'CHZUSDT', 'THETAUSDT',
                    'NEARUSDT', 'FTMUSDT', 'GRTUSDT', 'CRVUSDT', 'COMPUSDT',
                    'AAVEUSDT', 'MKRUSDT', 'UNIUSDT', 'SUSHIUSDT', 'YFIUSDT',
                    'APTUSDT', 'ARBUSDT', 'OPUSDT', 'SUIUSDT', 'SEIUSDT',
                    'RNDRUSDT', 'INJUSDT', 'IMXUSDT', 'STXUSDT', 'HBARUSDT',
                    'VETUSDT', 'TRXUSDT', 'ICPUSDT', 'EGLDUSDT', 'ONEUSDT'
                ];
                this.allSymbols = defaultSymbols;
                document.getElementById('totalPairs').textContent = this.allSymbols.length;
                return this.allSymbols;
            }

            async fetchBinanceData(symbol, interval = '1d', limit = 50) {
                try {
                    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Binance API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.map(candle => ({
                        time: candle[0],
                        open: parseFloat(candle[1]),
                        high: parseFloat(candle[2]),
                        low: parseFloat(candle[3]),
                        close: parseFloat(candle[4]),
                        volume: parseFloat(candle[5])
                    }));
                } catch (error) {
                    console.error(`Error fetching ${symbol}:`, error);
                    return null;
                }
            }

            async fetchCurrentPrice(symbol) {
                try {
                    const url = `https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) return null;
                    
                    const data = await response.json();
                    return {
                        symbol: data.symbol,
                        price: parseFloat(data.lastPrice),
                        priceChange: parseFloat(data.priceChange),
                        priceChangePercent: parseFloat(data.priceChangePercent),
                        volume: parseFloat(data.volume),
                        high: parseFloat(data.highPrice),
                        low: parseFloat(data.lowPrice)
                    };
                } catch (error) {
                    console.error(`Error fetching price for ${symbol}:`, error);
                    return null;
                }
            }

            // Advanced Technical Indicators
            calculateSMA(prices, period) {
                if (!prices || prices.length < period) return prices ? prices[prices.length - 1] : 0;
                const slice = prices.slice(-period);
                return slice.reduce((a, b) => a + b, 0) / period;
            }

            calculateEMA(prices, period) {
                if (!prices || prices.length < period) return prices ? prices[prices.length - 1] : 0;
                
                let ema = prices.slice(0, period).reduce((a, b) => a + b) / period;
                const multiplier = 2 / (period + 1);
                
                for (let i = period; i < prices.length; i++) {
                    ema = (prices[i] - ema) * multiplier + ema;
                }
                
                return ema;
            }

            calculateRSI(prices, period = 14) {
                if (!prices || prices.length < period + 1) return 50;
                
                let gains = 0;
                let losses = 0;
                
                for (let i = 1; i <= period; i++) {
                    const change = prices[prices.length - i] - prices[prices.length - i - 1];
                    if (change > 0) gains += change;
                    else losses -= change;
                }
                
                const avgGain = gains / period;
                const avgLoss = losses / period;
                
                if (avgLoss === 0) return 100;
                const rs = avgGain / avgLoss;
                return 100 - (100 / (1 + rs));
            }

            calculateMACD(prices) {
                if (!prices || prices.length < 26) return { macd: 0, signal: 0, histogram: 0 };
                
                const ema12 = this.calculateEMA(prices, 12);
                const ema26 = this.calculateEMA(prices, 26);
                const macd = ema12 - ema26;
                
                return {
                    macd: macd,
                    signal: macd, // Упрощенная версия для скорости
                    histogram: 0
                };
            }

            calculateBollingerBands(prices, period = 20) {
                if (!prices || prices.length < period) return { upper: 0, middle: 0, lower: 0 };
                
                const slice = prices.slice(-period);
                const middle = slice.reduce((a, b) => a + b, 0) / period;
                const std = Math.sqrt(slice.reduce((sum, price) => sum + Math.pow(price - middle, 2), 0) / period);
                
                return {
                    upper: middle + (std * 2),
                    middle: middle,
                    lower: middle - (std * 2)
                };
            }

            calculateStochasticOscillator(prices, period = 14) {
                if (!prices || prices.length < period) return { k: 50, d: 50 };
                
                const currentClose = prices[prices.length - 1];
                const periodHigh = Math.max(...prices.slice(-period));
                const periodLow = Math.min(...prices.slice(-period));
                
                const k = ((currentClose - periodLow) / (periodHigh - periodLow)) * 100;
                
                return { k, d: k }; // Упрощенная версия для скорости
            }

            calculateVolumeProfile(volumeData, priceData) {
                if (!volumeData || volumeData.length < 20) return { highVolumeZone: 0, lowVolumeZone: 0, volumeRatio: 1, isHighVolume: false, isLowVolume: false };
                
                const avgVolume = volumeData.reduce((a, b) => a + b, 0) / volumeData.length;
                const currentVolume = volumeData[volumeData.length - 1];
                const volumeRatio = currentVolume / avgVolume;
                
                return {
                    volumeRatio,
                    isHighVolume: volumeRatio > 1.5,
                    isLowVolume: volumeRatio < 0.5
                };
            }

            advancedTechnicalAnalysis(historicalData, currentPrice) {
                // Проверяем наличие данных
                if (!historicalData || !historicalData.length) {
                    return this.getDefaultTechnicalAnalysis(currentPrice);
                }

                const closes = historicalData.map(candle => candle.close);
                const volumes = historicalData.map(candle => candle.volume);
                
                if (closes.length < 26) {
                    return this.getDefaultTechnicalAnalysis(currentPrice);
                }

                // Упрощенные расчеты для скорости
                const sma20 = this.calculateSMA(closes, 20);
                const sma50 = this.calculateSMA(closes, 50);
                const sma200 = this.calculateSMA(closes, 200);
                const rsi = this.calculateRSI(closes);
                const macd = this.calculateMACD(closes);
                const bb = this.calculateBollingerBands(closes);
                const stochastic = this.calculateStochasticOscillator(closes);
                const volumeProfile = this.calculateVolumeProfile(volumes, closes);
                
                let score = 0;
                const signals = [];

                // Основные индикаторы для BUY сигналов
                if (rsi < 30) {
                    score += 3;
                    signals.push("RSI: ПЕРЕПРОДАНОСТЬ 🟢");
                } else if (rsi > 70) {
                    score -= 3;
                    signals.push("RSI: ПЕРЕКУПЛЕННОСТЬ 🔴");
                }

                if (currentPrice > sma20 && sma20 > sma50 && sma50 > sma200) {
                    score += 3;
                    signals.push("ТРЕНД: СИЛЬНЫЙ БЫЧИЙ 📈");
                } else if (currentPrice > sma20 && sma20 > sma50) {
                    score += 2;
                    signals.push("ТРЕНД: ВОСХОДЯЩИЙ 📈");
                } else if (currentPrice < sma20 && sma20 < sma50) {
                    score -= 2;
                    signals.push("ТРЕНД: НИСХОДЯЩИЙ 📉");
                }

                if (currentPrice < bb.lower) {
                    score += 2;
                    signals.push("ЦЕНА: НИЖЕ BB 🟢");
                } else if (currentPrice > bb.upper) {
                    score -= 2;
                    signals.push("ЦЕНА: ВЫШЕ BB 🔴");
                }

                if (macd.macd > 0) {
                    score += 1;
                    signals.push("MACD: БЫЧИЙ 📈");
                } else if (macd.macd < 0) {
                    score -= 1;
                    signals.push("MACD: МЕДВЕЖИЙ 📉");
                }

                if (stochastic.k < 20) {
                    score += 1;
                    signals.push("STOCHASTIC: ПЕРЕПРОДАНО 🟢");
                } else if (stochastic.k > 80) {
                    score -= 1;
                    signals.push("STOCHASTIC: ПЕРЕКУПЛЕНО 🔴");
                }

                if (volumeProfile.isHighVolume) {
                    score += 1;
                    signals.push("ОБЪЕМ: ВЫСОКИЙ 📊");
                }

                // Дополнительные критерии для URGENT SELL сигналов
                const isAfterBullRun = this.isAfterBullRun(closes);
                const isReversalPattern = this.isReversalPattern(closes, currentPrice);
                
                if (isAfterBullRun && isReversalPattern) {
                    score -= 5; // Сильное снижение оценки для срочной продажи
                    signals.push("⚠️ ПОСЛЕ БЫЧЬЕГО ТРЕНДА - Продажа");
                }

                return { 
                    score, 
                    signals, 
                    rsi: rsi || 50, 
                    sma20: sma20 || currentPrice, 
                    sma50: sma50 || currentPrice,
                    sma200: sma200 || currentPrice,
                    macd: macd?.macd || 0,
                    stochasticK: stochastic?.k || 50,
                    stochasticD: stochastic?.d || 50,
                    volumeProfile,
                    bb,
                    isAfterBullRun,
                    isReversalPattern
                };
            }

            getDefaultTechnicalAnalysis(currentPrice) {
                return { 
                    score: 0, 
                    signals: ["Недостаточно данных"], 
                    rsi: 50, 
                    sma20: currentPrice, 
                    sma50: currentPrice,
                    sma200: currentPrice,
                    macd: 0,
                    stochasticK: 50,
                    stochasticD: 50,
                    volumeProfile: { volumeRatio: 1, isHighVolume: false, isLowVolume: false },
                    bb: { upper: currentPrice, middle: currentPrice, lower: currentPrice },
                    isAfterBullRun: false,
                    isReversalPattern: false
                };
            }

            isAfterBullRun(closes) {
                if (!closes || closes.length < 30) return false;
                
                // Проверяем, был ли сильный рост в последние 20 свечей
                const recentCloses = closes.slice(-30);
                const startPrice = recentCloses[0];
                const endPrice = recentCloses[recentCloses.length - 1];
                const growthPercent = ((endPrice - startPrice) / startPrice) * 100;
                
                return growthPercent > 15; // Рост более 15% за 30 свечей
            }

            isReversalPattern(closes, currentPrice) {
                if (!closes || closes.length < 10) return false;
                
                // Простая проверка на разворот: цена падает после роста
                const recentCloses = closes.slice(-10);
                const peakPrice = Math.max(...recentCloses);
                const currentPosition = recentCloses.indexOf(peakPrice);
                
                // Если пик был не на последней свече и цена упала с пика
                return currentPosition < recentCloses.length - 2 && 
                       currentPrice < peakPrice * 0.98; // Упала на 2% от пика
            }

            generateSignal(score, symbol, priceData, technicals) {
                // Проверяем наличие данных
                if (!priceData || !technicals) {
                    return this.getDefaultSignal(symbol);
                }

                let finalSignal, strength, cssClass;
                
                // Условия для URGENT SELL (самый высокий приоритет)
                if (technicals.isAfterBullRun && technicals.isReversalPattern && score <= -3) {
                    finalSignal = "🔴 URGENT SELL";
                    strength = "КРИТИЧЕСКАЯ";
                    cssClass = "urgent-sell";
                }
                // Остальные сигналы
                else if (score >= 6) {
                    finalSignal = "🟢 СИЛЬНЫЙ BUY";
                    strength = "ОЧЕНЬ ВЫСОКАЯ";
                    cssClass = "strong-buy";
                } else if (score >= 3) {
                    finalSignal = "🟢 BUY";
                    strength = "ВЫСОКАЯ";
                    cssClass = "buy";
                } else if (score <= -6) {
                    finalSignal = "🔴 СИЛЬНЫЙ SELL";
                    strength = "ОЧЕНЬ ВЫСОКАЯ";
                    cssClass = "strong-sell";
                } else if (score <= -3) {
                    finalSignal = "🔴 SELL";
                    strength = "ВЫСОКАЯ";
                    cssClass = "sell";
                } else {
                    finalSignal = "🟡 HOLD";
                    strength = "НИЗКАЯ";
                    cssClass = "hold";
                }

                return {
                    symbol: symbol.replace('USDT', ''),
                    price: priceData.price || 0,
                    change24h: priceData.priceChangePercent || 0,
                    volume: priceData.volume || 0,
                    high: priceData.high || 0,
                    low: priceData.low || 0,
                    rsi: technicals.rsi || 50,
                    sma20: technicals.sma20 || 0,
                    sma50: technicals.sma50 || 0,
                    sma200: technicals.sma200 || 0,
                    macd: technicals.macd || 0,
                    stochasticK: technicals.stochasticK || 50,
                    stochasticD: technicals.stochasticD || 50,
                    volumeProfile: technicals.volumeProfile || { volumeRatio: 1, isHighVolume: false, isLowVolume: false },
                    finalSignal,
                    strength,
                    signals: technicals.signals ? technicals.signals.slice(0, 4) : ["Недостаточно данных"],
                    score: score || 0,
                    cssClass,
                    timestamp: Date.now(),
                    isAfterBullRun: technicals.isAfterBullRun || false,
                    isReversalPattern: technicals.isReversalPattern || false
                };
            }

            getDefaultSignal(symbol) {
                return {
                    symbol: symbol.replace('USDT', ''),
                    price: 0,
                    change24h: 0,
                    volume: 0,
                    high: 0,
                    low: 0,
                    rsi: 50,
                    sma20: 0,
                    sma50: 0,
                    sma200: 0,
                    macd: 0,
                    stochasticK: 50,
                    stochasticD: 50,
                    volumeProfile: { volumeRatio: 1, isHighVolume: false, isLowVolume: false },
                    finalSignal: "🟡 HOLD",
                    strength: "НИЗКАЯ",
                    signals: ["Недостаточно данных"],
                    score: 0,
                    cssClass: "hold",
                    timestamp: Date.now(),
                    isAfterBullRun: false,
                    isReversalPattern: false
                };
            }

            async analyzeSymbol(symbol) {
                try {
                    const [historicalData, currentPrice] = await Promise.all([
                        this.fetchBinanceData(symbol, '1d', 50),
                        this.fetchCurrentPrice(symbol)
                    ]);

                    // Если данные не получены, возвращаем сигнал по умолчанию
                    if (!historicalData || !currentPrice) {
                        console.warn(`No data for ${symbol}`);
                        return this.getDefaultSignal(symbol);
                    }

                    const technicals = this.advancedTechnicalAnalysis(historicalData, currentPrice.price);
                    return this.generateSignal(technicals.score, symbol, currentPrice, technicals);
                    
                } catch (error) {
                    console.error(`Analysis error for ${symbol}:`, error);
                    return this.getDefaultSignal(symbol);
                }
            }

            async analyzeAllSymbols() {
                // Получаем все символы, если еще не получили
                if (this.allSymbols.length === 0) {
                    await this.fetchAllSymbols();
                }
                
                const results = [];
                let completed = 0;
                const totalSymbols = this.allSymbols.length;

                updateStatus(`🔍 Analyzing ALL ${totalSymbols} Binance spot pairs...`);
                updateAnalysisInfo(completed, totalSymbols);

                for (const symbol of this.allSymbols) {
                    if (!this.isMonitoring && results.length > 100) break; // Лимит для ручного анализа

                    const result = await this.analyzeSymbol(symbol);
                    if (result) results.push(result);

                    completed++;
                    const progress = (completed / totalSymbols) * 100;
                    updateProgress(progress, completed, totalSymbols);
                    updateAnalysisInfo(completed, totalSymbols);
                    
                    // Минимальная задержка для API
                    await new Promise(resolve => setTimeout(resolve, this.analysisSpeed));
                }

                return results;
            }

            updateStatistics(signals) {
                if (!signals || !signals.length) {
                    this.resetStatistics();
                    return;
                }

                const strongBuy = signals.filter(s => s.cssClass === 'strong-buy').length;
                const buy = signals.filter(s => s.cssClass === 'buy').length;
                const urgentSell = signals.filter(s => s.cssClass === 'urgent-sell').length;
                const strongSell = signals.filter(s => s.cssClass === 'strong-sell').length;
                const sell = signals.filter(s => s.cssClass === 'sell').length;
                const totalSignals = signals.length;

                document.getElementById('totalSymbols').textContent = totalSignals;
                document.getElementById('strongBuyCount').textContent = strongBuy;
                document.getElementById('buyCount').textContent = buy;
                document.getElementById('urgentSellCount').textContent = urgentSell;
                document.getElementById('strongSellCount').textContent = strongSell;
                document.getElementById('sellCount').textContent = sell;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                // Обновляем верхнюю панель
                document.getElementById('marketStrongBuy').textContent = strongBuy;
                document.getElementById('marketUrgentSell').textContent = urgentSell;

                const validSignals = signals.filter(s => typeof s.score === 'number');
                const avgScore = validSignals.length > 0 ? 
                    validSignals.reduce((sum, signal) => sum + signal.score, 0) / validSignals.length : 0;
                
                let marketTrend = "НЕЙТРАЛЬНЫЙ";
                if (avgScore > 2) marketTrend = "СИЛЬНЫЙ БЫЧИЙ 🚀";
                else if (avgScore > 0.5) marketTrend = "БЫЧИЙ 📈";
                else if (avgScore < -2) marketTrend = "СИЛЬНЫЙ МЕДВЕЖИЙ 🚨";
                else if (avgScore < -0.5) marketTrend = "МЕДВЕЖИЙ 📉";
                
                document.getElementById('marketTrend').textContent = marketTrend;
            }

            resetStatistics() {
                document.getElementById('totalSymbols').textContent = 0;
                document.getElementById('strongBuyCount').textContent = 0;
                document.getElementById('buyCount').textContent = 0;
                document.getElementById('urgentSellCount').textContent = 0;
                document.getElementById('strongSellCount').textContent = 0;
                document.getElementById('sellCount').textContent = 0;
                document.getElementById('marketStrongBuy').textContent = 0;
                document.getElementById('marketUrgentSell').textContent = 0;
                document.getElementById('marketTrend').textContent = "-";
            }

            displaySignals(signals) {
                const grid = document.getElementById('signalsGrid');
                
                if (!signals || !signals.length) {
                    grid.innerHTML = '<div class="loading"><p>🤷 No signals available</p></div>';
                    return;
                }
                
                let filteredSignals = signals;
                if (this.currentFilter !== 'all') {
                    filteredSignals = signals.filter(signal => signal.cssClass === this.currentFilter);
                }
                
                // Сортируем по силе сигнала (абсолютное значение score)
                const sortedSignals = filteredSignals.sort((a, b) => Math.abs(b.score) - Math.abs(a.score));
                grid.innerHTML = '';

                if (sortedSignals.length === 0) {
                    grid.innerHTML = '<div class="loading"><p>🤷 No signals for current filter</p></div>';
                    return;
                }

                sortedSignals.forEach(signal => {
                    const card = document.createElement('div');
                    card.className = `signal-card ${signal.cssClass}`;
                    
                    const changeColor = signal.change24h >= 0 ? '#00ff88' : '#ff416c';
                    const changeIcon = signal.change24h >= 0 ? '📈' : '📉';
                    const volumeBadge = signal.volumeProfile?.isHighVolume ? 
                        '<span class="indicator-badge bullish">HIGH VOL</span>' : 
                        signal.volumeProfile?.isLowVolume ? 
                        '<span class="indicator-badge bearish">LOW VOL</span>' : 
                        '<span class="indicator-badge neutral">NORM VOL</span>';

                    // Добавляем специальную метку для URGENT SELL
                    const urgentBadge = signal.cssClass === 'urgent-sell' ? 
                        '<div style="background: rgba(255,0,0,0.3); padding: 5px; border-radius: 5px; margin-bottom: 10px; text-align: center; font-weight: bold;">🚨 Продажа</div>' : '';

                    card.innerHTML = `
                        ${urgentBadge}
                        <div class="coin-header">
                            <div class="coin-name">${signal.symbol}</div>
                            <div class="signal-type signal-${signal.cssClass.replace('-', '')}">
                                ${signal.finalSignal}
                            </div>
                        </div>
                        
                        <div class="price-info">
                            $${(signal.price || 0).toFixed(4)}
                        </div>
                        
                        <div class="price-change" style="color: ${changeColor}">
                            ${changeIcon} ${signal.change24h >= 0 ? '+' : ''}${(signal.change24h || 0).toFixed(2)}%
                        </div>
                        
                        <div class="indicators">
                            <div class="indicator">
                                <span>RSI:</span>
                                <span class="indicator-value">${(signal.rsi || 50).toFixed(1)}</span>
                            </div>
                            <div class="indicator">
                                <span>Stoch K:</span>
                                <span class="indicator-value">${(signal.stochasticK || 50).toFixed(1)}</span>
                            </div>
                            <div class="indicator">
                                <span>MACD:</span>
                                <span class="indicator-value">${(signal.macd || 0).toFixed(4)}</span>
                            </div>
                            <div class="indicator">
                                <span>SMA200:</span>
                                <span class="indicator-value">${(signal.sma200 || 0).toFixed(4)}</span>
                            </div>
                            <div class="indicator">
                                <span>Volume:</span>
                                <span class="indicator-value">${((signal.volume || 0) / 1000).toFixed(0)}K ${volumeBadge}</span>
                            </div>
                            <div class="indicator">
                                <span>Score:</span>
                                <span class="indicator-value">${(signal.score || 0).toFixed(1)}</span>
                            </div>
                        </div>
                        
                        <div class="signals-list">
                            ${(signal.signals || ["Недостаточно данных"]).map(signalText => `
                                <div class="signal-item">• ${signalText}</div>
                            `).join('')}
                        </div>
                        
                        <div class="confidence ${signal.strength === 'КРИТИЧЕСКАЯ' ? 'low-confidence' : 
                                            signal.strength === 'ОЧЕНЬ ВЫСОКАЯ' ? 'high-confidence' : 
                                            signal.strength === 'ВЫСОКАЯ' ? 'medium-confidence' : 'low-confidence'}">
                            Confidence: ${signal.strength}
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            }

            setFilter(filter) {
                this.currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                if (this.analysisResults.length > 0) {
                    this.displaySignals(this.analysisResults);
                }
            }

            async startMonitoring() {
                if (this.isMonitoring) return;
                
                this.isMonitoring = true;
                updateStatus('🚀 Full market monitoring started - All Binance spot pairs');

                const monitorLoop = async () => {
                    if (!this.isMonitoring) return;

                    try {
                        const startTime = Date.now();
                        const signals = await this.analyzeAllSymbols();
                        
                        this.analysisResults = signals;
                        this.updateStatistics(signals);
                        this.displaySignals(signals);

                        const analysisTime = ((Date.now() - startTime) / 1000).toFixed(1);
                        updateStatus(`✅ Full market analysis completed! ${signals.length}/${this.allSymbols.length} signals (${analysisTime}s) | Next in 5min`);
                        
                    } catch (error) {
                        console.error('Monitoring error:', error);
                        updateStatus('❌ Analysis failed - Retrying...');
                    }

                    if (this.isMonitoring) {
                        setTimeout(monitorLoop, 300000); // 5 минут
                    }
                };

                monitorLoop();
            }

            stopMonitoring() {
                this.isMonitoring = false;
                updateStatus('🛑 Monitoring stopped');
                updateProgress(0, 0, 0);
                updateAnalysisInfo(0, 0);
            }
        }

        // Глобальные функции
        const bot = new AdvancedBinanceSignalsBot();

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function updateProgress(percent, completed, total) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = 
                `${Math.round(percent)}% (${completed}/${total})`;
        }

        function updateAnalysisInfo(completed, total) {
            document.getElementById('analysisInfo').textContent = 
                `Analyzing: ${completed}/${total} coins`;
        }

        function startMonitoring() {
            bot.startMonitoring();
        }

        function stopMonitoring() {
            bot.stopMonitoring();
        }

        async function runSingleAnalysis() {
            bot.stopMonitoring();
            updateStatus('🔍 Running FULL market analysis of all spot pairs...');
            const signals = await bot.analyzeAllSymbols();
            bot.updateStatistics(signals);
            bot.displaySignals(signals);
            updateStatus(`✅ FULL market analysis completed! ${signals.length}/${bot.allSymbols.length} coins analyzed`);
        }

        function filterSignals(filter) {
            bot.setFilter(filter);
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', async function() {
            await bot.fetchAllSymbols();
            updateStatus(`🤖 Advanced Crypto Signals Ready - ${bot.allSymbols.length} Binance spot pairs`);
            updateAnalysisInfo(0, bot.allSymbols.length);
        });
    </script>
</body>
</html>
